# Single RUN that runs yum (rhel7) or dnf (rhel8) based on VARIANT
# Usage in Dockerfile:
#   ARG VARIANT=rhel7
#   ARG PACKAGES="pkg1 pkg2"
#   COPY rpm-deps-el7.tar /tmp/rpms.tar   # or rpm-deps-el8.tar for rhel8
#   RUN mkdir -p /tmp/rpms && tar -xvf /tmp/rpms.tar -C /tmp/rpms && rm /tmp/rpms.tar
#   Then paste the RUN below (or source this logic).

# --- Build args (set before RUN) ---
# ARG VARIANT=rhel7
# ARG PACKAGES=""

# --- Single RUN (paste into Dockerfile) ---
RUN set -e; \
    EXCLUDE="--exclude=libgomp*,ncurses*,gcc*,libquadmath-devel*,perl-Encode*,perl-interpreter*,automake*"; \
    if [ "${VARIANT}" = "rhel7" ]; then \
      yum update -y --skip-broken ${EXCLUDE} \
        && yum repolist -v \
        && yum groupinstall -y --skip-broken --nogpgcheck -v 'Development Tools' ${EXCLUDE} \
        && yum install -y --skip-broken --nogpgcheck -v /tmp/rpms/*.rpm ${PACKAGES} \
        && (test -x /usr/bin/python3.9 && ln -sf /usr/bin/python3.9 /usr/bin/python || ln -sf /usr/bin/python3 /usr/bin/python) \
        && yum clean all \
        && rm -rf /var/cache/yum /tmp/rpms; \
    else \
      dnf update -y --skip-broken ${EXCLUDE} \
        && dnf repolist --verbose \
        && dnf groupinstall -y --skip-broken --nogpgcheck --verbose 'Development Tools' ${EXCLUDE} \
        && dnf install -y --skip-broken --nogpgcheck --verbose /tmp/rpms/*.rpm ${PACKAGES} \
        && ln -sf /usr/bin/python3.9 /usr/bin/python \
        && dnf clean all \
        && rm -rf /var/cache/dnf /tmp/rpms; \
    fi
